# JSON è½¬æ¢è§„åˆ™ä½¿ç”¨æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬ç³»ç»Ÿæ”¯æŒå¯¹ API è¯·æ±‚ä½“ï¼ˆInbound Rulesï¼‰å’Œå“åº”ä½“ï¼ˆOutbound Rulesï¼‰è¿›è¡Œçµæ´»çš„ JSON è½¬æ¢ã€‚é€šè¿‡é…ç½®è§„åˆ™ï¼Œå¯ä»¥å®ç°å­—æ®µçš„æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ç­‰æ“ä½œã€‚

## ğŸ¯ è§„åˆ™ç»“æ„

æ¯æ¡è§„åˆ™åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼š

```json
{
  "path": "å­—æ®µè·¯å¾„",
  "action": "æ“ä½œç±»å‹",
  "value": "æ–°å€¼ï¼ˆå¯é€‰ï¼‰"
}
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `path` | string | âœ… | ç›®æ ‡å­—æ®µçš„è·¯å¾„è¡¨è¾¾å¼ |
| `action` | string | âœ… | æ“ä½œç±»å‹ï¼š`set`ã€`add`ã€`remove` |
| `value` | any | âš ï¸ | æ–°å€¼ï¼ˆ`remove` æ“ä½œæ—¶ä¸éœ€è¦ï¼‰ |

## ğŸ“ è·¯å¾„è¯­æ³•

### åŸºç¡€è¯­æ³•

| è¯­æ³• | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `field` | é¡¶å±‚å­—æ®µ | `"model"` â†’ `{"model": ...}` |
| `parent.child` | åµŒå¥—å­—æ®µ | `"user.email"` â†’ `{"user": {"email": ...}}` |
| `[n]` | æ•°ç»„ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰ | `"items[0]"` â†’ `{"items": [ç¬¬ä¸€ä¸ªå…ƒç´ , ...]}` |
| `[*]` | æ•°ç»„æ‰€æœ‰å…ƒç´  | `"items[*].name"` â†’ å¯¹æ¯ä¸ªå…ƒç´ çš„ name å­—æ®µæ“ä½œ |
| `*` | å¯¹è±¡æ‰€æœ‰é”® | `"headers.*"` â†’ å¯¹æ‰€æœ‰ header å­—æ®µæ“ä½œ |

**æ³¨æ„**ï¼šæ•°ç»„ç´¢å¼•æ”¯æŒä¸¤ç§å†™æ³•ï¼š
- `items[0]` - **æ¨è**ï¼Œæ›´ç®€æ´è‡ªç„¶
- `items.[0]` - ä¹Ÿæ”¯æŒï¼Œä¸ç‚¹å·æ›´ä¸€è‡´

### è·¯å¾„ç¤ºä¾‹

```javascript
// ç®€å•å­—æ®µ
"model"                    // é¡¶å±‚çš„ model å­—æ®µ

// åµŒå¥—å­—æ®µ
"user.profile.avatar"      // ä¸‰å±‚åµŒå¥—

// æ•°ç»„æ“ä½œï¼ˆæ¨èå†™æ³•ï¼‰
"messages[0]"              // ç¬¬ä¸€æ¡æ¶ˆæ¯
"messages[*]"              // æ‰€æœ‰æ¶ˆæ¯
"messages[*].role"         // æ‰€æœ‰æ¶ˆæ¯çš„ role å­—æ®µ

// å¤æ‚åµŒå¥—
"candidates[*].content.parts[0].text"  // Gemini API å“åº”ç»“æ„
```

## âš™ï¸ æ“ä½œç±»å‹

### 1. SET - ä¿®æ”¹ç°æœ‰å­—æ®µ

**è¡Œä¸º**ï¼šä»…ä¿®æ”¹å·²å­˜åœ¨çš„å­—æ®µï¼Œä¸ä¼šåˆ›å»ºæ–°å­—æ®µ

```json
{
  "path": "model",
  "action": "set",
  "value": "gpt-4"
}
```

**ç¤ºä¾‹**ï¼š

```javascript
// è¾“å…¥
{"model": "gpt-3.5-turbo", "temperature": 0.7}

// è§„åˆ™
[{"path": "model", "action": "set", "value": "gpt-4"}]

// è¾“å‡º
{"model": "gpt-4", "temperature": 0.7}
```

**é‡è¦**ï¼šå¦‚æœå­—æ®µä¸å­˜åœ¨ï¼ŒSET æ“ä½œä¸ä¼šæ·»åŠ è¯¥å­—æ®µã€‚

### 2. ADD - æ·»åŠ æ–°å­—æ®µ

**è¡Œä¸º**ï¼šä»…æ·»åŠ ä¸å­˜åœ¨çš„å­—æ®µï¼Œå·²å­˜åœ¨çš„å­—æ®µä¸ä¼šè¢«è¦†ç›–

```json
{
  "path": "stream",
  "action": "add",
  "value": true
}
```

**ç¤ºä¾‹**ï¼š

```javascript
// è¾“å…¥
{"model": "gpt-4"}

// è§„åˆ™
[{"path": "stream", "action": "add", "value": true}]

// è¾“å‡º
{"model": "gpt-4", "stream": true}
```

**é‡è¦**ï¼šå¦‚æœå­—æ®µå·²å­˜åœ¨ï¼ŒADD æ“ä½œä¸ä¼šä¿®æ”¹å®ƒã€‚

### 3. REMOVE - åˆ é™¤å­—æ®µ

**è¡Œä¸º**ï¼šåˆ é™¤æŒ‡å®šçš„å­—æ®µ

```json
{
  "path": "metadata.internal_id",
  "action": "remove"
}
```

**ç¤ºä¾‹**ï¼š

```javascript
// è¾“å…¥
{"model": "gpt-4", "metadata": {"internal_id": "123", "user": "admin"}}

// è§„åˆ™
[{"path": "metadata.internal_id", "action": "remove"}]

// è¾“å‡º
{"model": "gpt-4", "metadata": {"user": "admin"}}
```

**æ³¨æ„**ï¼š`value` å­—æ®µä¸éœ€è¦å¡«å†™ã€‚

## ğŸ“ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šç»Ÿä¸€æ¨¡å‹åç§°ï¼ˆè¯·æ±‚ä½“è½¬æ¢ï¼‰

**éœ€æ±‚**ï¼šå°†æ‰€æœ‰ `gpt-3.5-turbo` è¯·æ±‚é‡å®šå‘åˆ° `gpt-4`

```json
{
  "path": "model",
  "action": "set",
  "value": "gpt-4"
}
```

### åœºæ™¯ 2ï¼šå¼ºåˆ¶å¼€å¯æµå¼å“åº”

**éœ€æ±‚**ï¼šç¡®ä¿æ‰€æœ‰è¯·æ±‚éƒ½ä½¿ç”¨æµå¼ä¼ è¾“

```json
{
  "path": "stream",
  "action": "set",
  "value": true
}
```

### åœºæ™¯ 3ï¼šGemini å“åº”æ ¼å¼è½¬ OpenAI

**éœ€æ±‚**ï¼šç§»é™¤ Gemini å“åº”ä¸­çš„ thoughtSignature å­—æ®µ

```json
{
  "path": "candidates[*].content.parts[*].thoughtSignature",
  "action": "remove"
}
```

### åœºæ™¯ 4ï¼šç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼ˆå“åº”ä½“è½¬æ¢ï¼‰

**éœ€æ±‚**ï¼šåˆ é™¤å“åº”ä¸­çš„å†…éƒ¨ ID å’Œè°ƒè¯•ä¿¡æ¯

```json
[
  {
    "path": "metadata.internal_id",
    "action": "remove"
  },
  {
    "path": "debug_info",
    "action": "remove"
  }
]
```

### åœºæ™¯ 5ï¼šæ‰¹é‡ä¿®æ”¹æ•°ç»„å…ƒç´ 

**éœ€æ±‚**ï¼šä¸ºæ‰€æœ‰æ¶ˆæ¯ç»Ÿä¸€è®¾ç½®è§’è‰²

```json
{
  "path": "messages[*].role",
  "action": "set",
  "value": "user"
}
```

### åœºæ™¯ 6ï¼šæ·»åŠ é»˜è®¤å‚æ•°

**éœ€æ±‚**ï¼šä¸ºæ²¡æœ‰æŒ‡å®š temperature çš„è¯·æ±‚æ·»åŠ é»˜è®¤å€¼

```json
{
  "path": "temperature",
  "action": "add",
  "value": 0.7
}
```

## ğŸ”§ é…ç½®æ–¹å¼

### åœ¨ Web ç•Œé¢é…ç½®

1. è¿›å…¥åˆ†ç»„ç®¡ç†é¡µé¢
2. åˆ›å»ºæˆ–ç¼–è¾‘åˆ†ç»„
3. æ‰¾åˆ°"å…¥ç«™è§„åˆ™"ï¼ˆè¯·æ±‚ä½“è½¬æ¢ï¼‰æˆ–"å‡ºç«™è§„åˆ™"ï¼ˆå“åº”ä½“è½¬æ¢ï¼‰
4. ç‚¹å‡»"æ·»åŠ è§„åˆ™"
5. å¡«å†™è·¯å¾„ã€é€‰æ‹©æ“ä½œç±»å‹ã€è¾“å…¥å€¼
6. ä¿å­˜é…ç½®

### JSON æ ¼å¼ç¤ºä¾‹

```json
{
  "inbound_rules": [
    {
      "path": "model",
      "action": "set",
      "value": "gpt-4"
    },
    {
      "path": "temperature",
      "action": "add",
      "value": 0.7
    }
  ],
  "outbound_rules": [
    {
      "path": "metadata.internal_id",
      "action": "remove"
    }
  ]
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ“ä½œä¼˜å…ˆçº§

è§„åˆ™æŒ‰é¡ºåºæ‰§è¡Œï¼Œåé¢çš„è§„åˆ™å¯èƒ½è¦†ç›–å‰é¢çš„ç»“æœï¼š

```json
[
  {"path": "model", "action": "set", "value": "gpt-4"},
  {"path": "model", "action": "set", "value": "gpt-3.5"}  // æœ€ç»ˆç”Ÿæ•ˆ
]
```

### 2. SET vs ADD çš„åŒºåˆ«

| åœºæ™¯ | SET | ADD |
|------|-----|-----|
| å­—æ®µä¸å­˜åœ¨ | âŒ ä¸æ·»åŠ  | âœ… æ·»åŠ  |
| å­—æ®µå·²å­˜åœ¨ | âœ… ä¿®æ”¹ | âŒ ä¸ä¿®æ”¹ |

**æ¨è**ï¼š
- ä¿®æ”¹ç°æœ‰å­—æ®µ â†’ ä½¿ç”¨ `set`
- æ·»åŠ å¯é€‰å­—æ®µ â†’ ä½¿ç”¨ `add`

### 3. æ•°ç»„ç´¢å¼•è¶Šç•Œ

è®¿é—®ä¸å­˜åœ¨çš„æ•°ç»„ç´¢å¼•ä¼šè¢«å¿½ç•¥ï¼š

```json
// è¾“å…¥ï¼š{"items": [1, 2, 3]}
// è§„åˆ™ï¼š{"path": "items[10]", "action": "set", "value": 99}
// è¾“å‡ºï¼š{"items": [1, 2, 3]}  // ç´¢å¼•10ä¸å­˜åœ¨ï¼Œæ“ä½œè¢«å¿½ç•¥
```

### 4. è·¯å¾„ä¸å­˜åœ¨

å¦‚æœä¸­é—´è·¯å¾„ä¸å­˜åœ¨ï¼Œæ“ä½œä¼šè¢«å¿½ç•¥ï¼š

```json
// è¾“å…¥ï¼š{"user": null}
// è§„åˆ™ï¼š{"path": "user.email", "action": "set", "value": "test@example.com"}
// è¾“å‡ºï¼š{"user": null}  // user ä¸æ˜¯å¯¹è±¡ï¼Œæ“ä½œè¢«å¿½ç•¥
```

### 5. å€¼çš„ç±»å‹

`value` å­—æ®µæ”¯æŒæ‰€æœ‰ JSON ç±»å‹ï¼š

```json
// å­—ç¬¦ä¸²
{"path": "name", "action": "set", "value": "Alice"}

// æ•°å­—
{"path": "count", "action": "set", "value": 42}

// å¸ƒå°”å€¼
{"path": "active", "action": "set", "value": true}

// å¯¹è±¡
{"path": "metadata", "action": "set", "value": {"key": "value"}}

// æ•°ç»„
{"path": "tags", "action": "set", "value": ["tag1", "tag2"]}

// null
{"path": "optional", "action": "set", "value": null}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### é›¶æ‹·è´é€ä¼ 

å½“åˆ†ç»„æ²¡æœ‰é…ç½®ä»»ä½•è§„åˆ™æ—¶ï¼Œç³»ç»Ÿä½¿ç”¨é›¶æ‹·è´æ¨¡å¼ç›´æ¥é€ä¼ æ•°æ®ï¼Œæ€§èƒ½æŸè€—å‡ ä¹ä¸ºé›¶ã€‚

### æµå¼å¤„ç†

ç³»ç»Ÿé‡‡ç”¨åˆ†å—æµå¼å¤„ç†ï¼Œæ— è®º JSON æ–‡ä»¶å¤šå¤§éƒ½ä¸ä¼šå ç”¨è¿‡å¤šå†…å­˜ã€‚

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. ä½¿ç”¨æµ‹è¯•å·¥å…·éªŒè¯

```bash
curl -X POST http://localhost:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-key" \
  -d '{
    "model": "test-model",
    "messages": [{"role": "user", "content": "hello"}]
  }'
```

### 2. æŸ¥çœ‹æ—¥å¿—

ç³»ç»Ÿä¼šè®°å½•è§„åˆ™åº”ç”¨æƒ…å†µï¼Œå¯ä»¥é€šè¿‡æ—¥å¿—ç¡®è®¤è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆã€‚

### 3. åˆ†æ­¥æµ‹è¯•

å¤æ‚è§„åˆ™å»ºè®®åˆ†æ­¥æµ‹è¯•ï¼š
1. å…ˆæµ‹è¯•å•æ¡è§„åˆ™
2. ç¡®è®¤æ— è¯¯åé€æ­¥æ·»åŠ 
3. æ³¨æ„è§„åˆ™ä¹‹é—´çš„äº¤äº’å½±å“

## ğŸ“š å¸¸è§é—®é¢˜

### Q: SET å’Œ ADD æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

A: 
- **SET**ï¼šåªä¿®æ”¹å·²å­˜åœ¨çš„å­—æ®µï¼Œä¸ä¼šæ·»åŠ æ–°å­—æ®µ
- **ADD**ï¼šåªæ·»åŠ ä¸å­˜åœ¨çš„å­—æ®µï¼Œä¸ä¼šè¦†ç›–å·²æœ‰å­—æ®µ

### Q: å¦‚ä½•æ‰¹é‡æ“ä½œæ•°ç»„æ‰€æœ‰å…ƒç´ ï¼Ÿ

A: ä½¿ç”¨ `[*]` é€šé…ç¬¦ï¼š

```json
{
  "path": "items[*].status",
  "action": "set",
  "value": "active"
}
```

### Q: è§„åˆ™æ‰§è¡Œé¡ºåºé‡è¦å—ï¼Ÿ

A: æ˜¯çš„ã€‚è§„åˆ™æŒ‰é…ç½®é¡ºåºæ‰§è¡Œï¼Œåé¢çš„è§„åˆ™å¯èƒ½è¦†ç›–å‰é¢çš„ç»“æœã€‚

### Q: ä¸ºä»€ä¹ˆæˆ‘çš„è§„åˆ™æ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
2. ä¸­é—´è·¯å¾„æ˜¯å¦å­˜åœ¨
3. SET æ“ä½œçš„å­—æ®µæ˜¯å¦å·²å­˜åœ¨
4. æ•°ç»„ç´¢å¼•æ˜¯å¦è¶Šç•Œ
5. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

## ğŸ“š å‚è€ƒèµ„æ–™

- **è·¯å¾„è§£æå®ç°**ï¼š`internal/jsonengine/path.go`
- **è§„åˆ™å¤„ç†é€»è¾‘**ï¼š`internal/jsonengine/path_processor.go`
- **é›¶æ‹·è´ä¼˜åŒ–**ï¼š`internal/jsonengine/engine.go`
- **æµ‹è¯•ç”¨ä¾‹**ï¼š`internal/jsonengine/path_engine_test.go`

---

**ç‰ˆæœ¬**ï¼šv1.0  
**æ›´æ–°æ—¶é—´**ï¼š2025-12-24  
**ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ Issue åé¦ˆã€‚
